---
title: "Project1"
author: "Unknown"
date: "10/27/2019"
output:
  html_document:
    toc: true
    theme: united
    toc_position: right
    toc_depth: 2
    toc_float: yes
    smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Desktop/bioinf/R statistics/Data/") #Задаем папку с файлами
```

## Задание №1
### Пользовательская функция для объединения всех файлов из заданной папки.

Перед запуском проверяем текущую папку (в адресе должно быть указание папки, в которой лежат данные. Также проверяем, что в такой папке лежат только необходимые данные с расширением csv.
```{r echo=FALSE}
getwd()
files <- list.files()
```
Пользовательская функция по объединению всех файлов будет иметь следующий вид:
```{r echo=TRUE}

all_files <- function(files, dataset){
  len <- length(files)
  dataset <- read.csv(files[1])
  for (i in 2:len){
    a <- read.csv(files[i])
    dataset <- rbind(dataset, a)
  }
write.csv(dataset, "../merged_files.csv")
}

all_files(files, dataset) #Указываем имя для входного переменной со списком всех данных и имя для новой переменной, в которую будут объединены все данные
```

Проверяем получившийся файл и число объектов. Радуемся.

```{r echo=FALSE}
dataset <- read.csv("../merged_files.csv")
str(dataset)
```


## Задание №2
### Проверка корректности данных.

```{r include=FALSE}
library(dplyr)
library(ggplot2)
#library(cowplot)
```
По структуре данных видно, что переменные Rings, Length и Sex... имеют тип "Factor":

```{r echo=FALSE}
str(dataset) 
```

Вывод всех уровней переменной Rings показал, что единственный параметр, требующий замены - "nine":
```{r echo=FALSE}
sort(levels(dataset$Rings))
```

```{r echo=FALSE}
dataset <- dataset %>% 
  mutate(Rings =replace(Rings,which(Rings == 'nine'), 9))
dataset$Rings <-  as.numeric(as.character(dataset$Rings))
```

Вывод всех уровней переменной Length показал, что нет таких числовых параметров, которые были записаны в буквенном виде, поэтому можно сразу перевести всё в числовой формат без дополнительных изменений:
```{r echo=FALSE}
sort(levels(dataset$Length))
```

Единственное измерение вида "No data! I forgot to mesure it!(" из переменной Length автоматически перевелось в тип NA:
```{r echo=FALSE}
dataset$Length <- as.numeric(as.character(dataset$Length))
```

Вывод всех уровней переменной пола показал, что некоторые измерения, которые должны быть числовыми, записаны словами:
```{r echo=FALSE}
levels(dataset$Sex..1...male..2...female..3...uvenil.)
```


После преобразования переменных видно, что все числовые параметры записаны как числа:
```{r echo=FALSE}

dataset <- dataset %>% 
  mutate(Sex..1...male..2...female..3...uvenil. =replace(Sex..1...male..2...female..3...uvenil.,which(Sex..1...male..2...female..3...uvenil. == 'male'), 1))
dataset <- dataset %>% 
  mutate(Sex..1...male..2...female..3...uvenil. =replace(Sex..1...male..2...female..3...uvenil.,which(Sex..1...male..2...female..3...uvenil. == 'one'), 1))
dataset <- dataset %>% 
  mutate(Sex..1...male..2...female..3...uvenil. =replace(Sex..1...male..2...female..3...uvenil.,which(Sex..1...male..2...female..3...uvenil. == 'three'), 3))


dataset$Sex..1...male..2...female..3...uvenil. <- as.numeric(as.character(dataset$Sex..1...male..2...female..3...uvenil.))


str(dataset)
```

Проверка на наличие NA данных в столбцах выявила некоторые из них. В столбце с определением пола есть NA значение - можно удалить, поскольку такое значение не восстановить по другим (и потеря одного измерения из 4177 не будет критичной). Остальные NA заменили на все самые частые значения по переменной, в которой находится NA, чтобы минимизировать их вклад (хотя пропущенных данных не очень много - 22 значения на весь датафрейм, и любая замена ничего серьёзного не внесет):

```{r echo=FALSE}
#Проверяем наличие NA в каждом из столбцов
for (i in 1:length(dataset)){
  if (sum(is.na(dataset[i])) != 0){
    print("столбцы с NA")
    print(i)
  }
}

dataset_no_NA <- dataset %>% filter(!is.na(Sex..1...male..2...female..3...uvenil.))
#str(dataset_no_NA) #Проверили, что удалилось только одно измерение

dataset_no_NA <- mutate_if(dataset_no_NA, is.numeric, ~replace(., is.na(.), median(., na.rm = TRUE))) 
```

## Задание №3
### Среднее значение и стандартное отклонение переменной Length для моллюсков разного пола.

Вычисление значений среднего и стандартное отклонение переменной Length для моллюсков разного пола привело к следующим результатам:

```{r echo=FALSE}

mean_sd_female <- dataset_no_NA %>% filter(dataset_no_NA$Sex..1...male..2...female..3...uvenil. == 2) %>% 
  summarise(mean = mean(Length), sd = sd(Length))
mean_sd_male <- dataset_no_NA %>%  filter(dataset_no_NA$Sex..1...male..2...female..3...uvenil. == 1) %>% 
  summarise(mean = mean(Length), sd = sd(Length))
mean_sd_juv <- dataset_no_NA %>%  filter(dataset_no_NA$Sex..1...male..2...female..3...uvenil. == 3) %>% 
  summarise(mean = mean(Length), sd = sd(Length))

sex <- c("female", "male", "juvenile")
mean_sd <- rbind(mean_sd_female, mean_sd_male, mean_sd_juv)
mean_sd <- cbind(sex,mean_sd)
mean_sd
```

```{r echo=FALSE, message=FALSE}
plot_mean_sd <- ggplot(mean_sd, aes(x=sex, y=mean)) + 
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin=mean_sd$mean-mean_sd$sd, ymax=mean_sd$mean+mean_sd$sd), width=.2,)+
  labs(title="Длины моллюсков разного пола", x="Пол моллюска", y = "Длина моллюска, м")
plot_mean_sd
```

### Вывод:
_По значениям из таблицы, а также по графику для средних значений и стандартных отклонений длин моллюсков в зависимости от их пола видно, что пол не влияет на различия между женскими и мужскими особями. Для молодых особей наблюдается некоторое снижение, что может объясняться их возрастом и неоконченной стадией роста._


## Задание №4
### Определение процента моллюсков, у которых значение переменной Height не превышает 0.165

Для определения процента моллюсков, подходящих под условие было необходимо сначала отобрать всех особей, параметр Height которых не превышает 0.165 и затем разделить полученное число на общее число наблюдений. 

```{r echo=FALSE}

data_height <- dataset_no_NA %>% filter(Height <= 0.165)
per <- round(nrow(data_height)*100/nrow(dataset_no_NA), 2)
```
Вычисленное значение будет равно `r per`%.

Построение распределения высот моллюсков в выборке визуально подтвердило правильность полученных результатов:

```{r echo=FALSE}
plot_hist <- ggplot(data=dataset_no_NA, aes(dataset_no_NA$Height)) + 
  geom_bar() + labs(title="Распределение высот моллюсков в выборке", x="Высота моллюска, м", y = "Количество особей, шт") + geom_vline(xintercept= 0.165, linetype="dashed", color = "red")
plot_hist
```

### Вывод:
_Значение переменной Height для `r per`% моллюсков не превышает 0.165._

## Задание №5
### Определение значения переменной Length, которое выше чем 92% от всех наблюдений

```{r include=FALSE}
number <- nrow(dataset_no_NA)*0.92

for (i in sort(dataset_no_NA$Length)){
  data_len <- dataset_no_NA %>% filter(Length <= i)
  per <- nrow(data_len)*100/nrow(dataset_no_NA)
  if (per >= 92){
    print(i)
    break
  }
}
```
Вычисление значения переменной Length, удовлетворяющего условию, привело к получению значения `r i`%.

Визуализация результатов:
```{r echo=FALSE}
#data_length <- dataset_no_NA %>% summary(Height <= 0.165)

plot_length <- ggplot(data=dataset_no_NA, aes(dataset_no_NA$Length)) + 
  geom_bar() + labs(title="Распределение высот моллюсков в выборке", x="Высота моллюска, м", y = "Количество особей, шт") + geom_vline(xintercept= 0.67, linetype="dashed", color = "red")
plot_length
```


### Вывод:
_Для 92% моллюсков значение переменной Length не превышает 0.67._

## Задание №6
### Стандартизация переменной Length и сохранение полученных данных в новую переменную Lenght_z_scores

Проведение стандартизации и добавления новой переменной были проведены и проверены с помощью apply, а также с помощью вывода нового датасета. Новая переменная добавлена (проверка всех переменных):
```{r echo=FALSE}
dataset_no_NA$Length_z_scores <- scale(dataset_no_NA$Length)
str(dataset_no_NA)
```
Проверяем sd переменной после стандартизации:
```{r echo=FALSE}
apply(dataset_no_NA[11], 2, sd) 
```
Проверяем mean переменной после стандартизации:
```{r echo=FALSE}
apply(dataset_no_NA[11], 2, mean) 
```

По графикам до и после стандартизации переменной Length видно, что вид распределения не изменился, однако, произошли изменения шкалы результатов.
```{r echo=FALSE}
plot_length_z <- ggplot(data=dataset_no_NA, aes(dataset_no_NA$Length_z_scores)) + 
  geom_density() + labs(title="Распределение длины моллюсков после стандартизации", x="Высота моллюска, м", y = "Количество особей, шт")
plot_length_z
plot_length_no_z <- ggplot(data=dataset_no_NA, aes(dataset_no_NA$Length)) + 
  geom_density() + labs(title="Распределение длины моллюсков до стандартизации", x="Высота моллюска, м", y = "Количество особей, шт")
plot_length_no_z

#library(cowplot)
#plot_grid(plot_length_no_z, plot_length)
```
### Вывод:
_После проведения стандартизации изменилась только шкала данных, но не распределение данных - всё прошло по плану._


## Задание №7
### Сравнение диаметров моллюсков с числом колец 5 и 15

По построению графика средних диаметров моллюсков видно, что скорее всего наблюдается статистическое различие между данными переменными. Необходимо проверить это каким-либо тестом. Поскольку для каждого параметра колец, число наблюдений >100, то можно воспользоваться t-критерием, предварительно проверив нормальность.
```{r echo=FALSE}
diam_5_15 <- dataset_no_NA %>% filter(dataset_no_NA$Rings == 5 | dataset_no_NA$Rings == 15)

diam_plot <- ggplot(diam_5_15, aes(x = as.factor(Rings), y = Diameter))+
stat_summary(fun.data = mean_cl_boot, geom = "errorbar", width = 0.2) + 
stat_summary(fun.data = mean_cl_boot, geom = "point") +
  labs(title="Диаметр моллюсков для числа колец 5 и 15", x="Количество колец, шт", y = "Диаметр моллюска, м")
diam_plot
```

Сформулируем гипотезу H0 для обоих распределений: пусть каждое из распределений не отличается от нормального.
```{r echo=FALSE}
diam_5 <- dataset_no_NA %>% filter(dataset_no_NA$Rings == 5)
aaa <-  shapiro.test(diam_5$Diameter) #не отличается от нормального
#aaa[2]
diam_15 <- dataset_no_NA %>% filter(dataset_no_NA$Rings == 15)
bbb <- shapiro.test(diam_15$Diameter)
#bbb[2]#не отличается от нормального

t_test <- t.test(diam_5$Diameter, diam_15$Diameter)
```
 Значения p-value для распределений диаметров моллюсков с числом колец 5 и 15 составили `r aaa[2]` и `r bbb[2]`, соответственно. Рассчитанные значения превышают уровень значимости p = 0.05 и не позволяют отклонить нулевую гипотезу. То есть обе переменные распределены нормально.
 Для сравнения 2х распределений между собой H0-гипотеза будет иметь следующий вид: пусть распределения не отличаются между собой. P-value для такой гипотезы составляет (`r t_test[3]`) и не позволяет принять H0 - принимаем гипотезу H1, которая говорит о наличии различий между выборками.

### Вывод:
_Выборки для диаметров моллюсков с числом колец 5 и 15 имеют нормальное распределение, что позволяет сравнить их по t-критерию. Выборки различаются между собой достоверно._

## Задание №8
### Корреляционная взаимосвязь переменных Diametr и Whole_weight

```{r include=FALSE}
cor_param <- cor.test(dataset_no_NA$Diameter, dataset_no_NA$Whole_weight, method = "spearman")$estimate
cor_param
```

_Вычисление значения корреляции для переменных Diametr и Whole_weight показало, что параметр корреляции близок к 1 (_ `r cor_param` _), при p < 2.2e-16,  то есть можно сказать, что наблюдается положительная корреляция между весом и диаметром моллюска. То есть с увеличением одного параметра, увеличивается и другой:_
```{r echo=FALSE, warning=FALSE}
cor_param <- cor.test(dataset_no_NA$Diameter, dataset_no_NA$Whole_weight, method = "spearman")$estimate
cor_param
```

_Построение зависимости веса от диаметра моллюска выявили exp рост веса при увеличении диаметра:_
```{r echo=FALSE, message=FALSE}
diam_ww <- ggplot(dataset_no_NA, aes(x = Diameter, y = Whole_weight))+ 
  geom_point()+
  geom_smooth() +
  labs(title="График зависимости веса моллюска от его диаметра", x="Диаметр моллюска, м", y = "Вес моллюска, кг")
diam_ww
```

_Построение зависимости веса от диаметра моллюска для каждого пола не выявило значительных отличий темпов роста между собой  exp рост веса при увеличении диаметра._


```{r echo=FALSE, message=FALSE}
diam_ww_sex <- ggplot(dataset_no_NA, aes(x = Diameter, y = Whole_weight, color = as.factor(Sex..1...male..2...female..3...uvenil.)))+ 
  geom_point()+
  geom_smooth() +
  labs(title="График зависимости веса моллюска от его диаметра", x="Диаметр моллюска, м", y = "Вес моллюска, кг") + facet_grid(dataset_no_NA$Sex..1...male..2...female..3...uvenil.) 
diam_ww_sex + scale_fill_continuous(name = "Пол моллюска", labels = c("Male", "Female", "Juvenile"))
```




